name: Deploy MCP Agent System - Gemini Edition

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AZURE_WEBAPP_NAME: mcp-agent-gemini    # Azure Web Appå
  AZURE_WEBAPP_PACKAGE_PATH: '.'        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‘ã‚¹
  NODE_VERSION: '18.x'                  # Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³
  POWERSHELL_VERSION: '7.x'             # PowerShellãƒãƒ¼ã‚¸ãƒ§ãƒ³

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Setup PowerShell
      uses: azure/powershell@v1
      with:
        azPSVersion: 'latest'
        inlineScript: |
          Write-Host "PowerShellç’°å¢ƒç¢ºèªå®Œäº†"
          $PSVersionTable
    
    - name: Install dependencies
      run: |
        npm install --global npm@latest
        echo "ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
    
    - name: Run frontend tests
      run: |
        echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        node -c frontend/js/app.js
        node -c frontend/js/api-client.js
        node -c frontend/js/mcp-agent.js
        echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº†"
    
    - name: Validate PowerShell scripts
      shell: pwsh
      run: |
        Write-Host "PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆæ¤œè¨¼ä¸­..."
        $script = Get-Content -Path "backend/api.ps1" -Raw
        $errors = $null
        $null = [System.Management.Automation.PSParser]::Tokenize($script, [ref]$errors)
        if ($errors.Count -gt 0) {
          Write-Error "PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
          $errors | ForEach-Object { Write-Error $_.Message }
          exit 1
        }
        Write-Host "âœ… PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆæ¤œè¨¼å®Œäº†"
    
    - name: Security scan
      run: |
        echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­..."
        # åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        if grep -r "your_gemini_api_key_here" . --exclude-dir=.git; then
          echo "âš ï¸  è­¦å‘Š: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAPIã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        fi
        
        if grep -r "password" . --exclude-dir=.git --exclude="*.yml" --exclude="*.md"; then
          echo "â„¹ï¸  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–¢é€£ã®ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æ¨å¥¨ï¼‰"
        fi
        
        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
    
    - name: Build artifacts
      run: |
        echo "ãƒ“ãƒ«ãƒ‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä½œæˆä¸­..."
        mkdir -p dist
        cp -r frontend dist/
        cp -r backend dist/
        cp -r scripts dist/
        cp README.md dist/
        cp start-server.bat dist/
        echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: mcp-agent-gemini-build
        path: dist/
        retention-days: 30

  deploy-azure:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    name: Deploy to Azure
    
    environment:
      name: 'Production'
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: mcp-agent-gemini-build
        path: ./deploy
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure Web App
      id: deploy
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ./deploy
        
    - name: Configure App Settings
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        app-settings-json: |
          [
            {
              "name": "GEMINI_API_KEY",
              "value": "${{ secrets.GEMINI_API_KEY }}",
              "slotSetting": false
            },
            {
              "name": "JWT_SECRET",
              "value": "${{ secrets.JWT_SECRET }}",
              "slotSetting": false
            },
            {
              "name": "ENVIRONMENT",
              "value": "production",
              "slotSetting": false
            }
          ]
    
    - name: Health Check
      run: |
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        sleep 30
        
        HEALTH_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health"
        
        for i in {1..5}; do
          echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è©¦è¡Œ $i/5..."
          
          if curl -f -s "$HEALTH_URL" | grep -q "healthy"; then
            echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $HEALTH_URL"
            exit 0
          fi
          
          echo "â³ 30ç§’å¾…æ©Ÿ..."
          sleep 30
        done
        
        echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
        exit 1

  deploy-notification:
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-azure]
    if: always()
    name: Deployment Notification
    
    steps:
    - name: Notify Success
      if: needs.deploy-azure.result == 'success'
      run: |
        echo "ğŸ‰ MCP Agent System (Gemini Edition) ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ!"
        echo "ğŸŒ URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health"
        echo "ğŸ¤– Provider: Google Gemini Pro"
    
    - name: Notify Failure
      if: needs.build-and-test.result == 'failure' || needs.deploy-azure.result == 'failure'
      run: |
        echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
        echo "ğŸ“‹ ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        echo "ğŸ”§ ä¿®æ­£å¾Œã«å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„"